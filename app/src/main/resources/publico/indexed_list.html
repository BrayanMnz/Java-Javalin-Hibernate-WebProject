<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text= "${titulo}">Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    


    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>



<!------ Para el Navbar---------->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Para el Navbar---------->

    <style>
        #nav-link{
         text-decoration: none;
         color: white;
       }

       #nav-link:hover{
         text-decoration: underline;
         color: red;
       }
       .main_heading{
        text-align: center;
        color: darkgoldenrod;
        /* background: rgb(0,0,0); */
background: linear-gradient(130deg, dimgray,  rgba(1,1,1,1) 93%, dimgray 65%, rgba(1,1,1,1) 93%);
       }
       #navigation{
        list-style-type: none;
       }
       .topnav a:hover {
    border-bottom: 3px solid red;
}
#navi{
        color: black;
    }

    </style>
</head>




<body style="background: -webkit-linear-gradient(left, #3931af, #00c6ff);">
    

    	                <!-- Navigation Bar  -->
                    
                      <nav id="navbar" class="navbar navbar-expand-lg navbar-light " style=" background: -webkit-linear-gradient(right, #3931af, #00c6ff);">
                        <a class="navbar-brand" href="/Principal/Home">PUCMM, Oficina Planeamiento</a>
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav ml-auto topnav">
                               
                                <li class="nav-item">
                                    <li class="nav-link">
                                        <a id="navi" href="#" class="dropdown-toggle" data-toggle="dropdown">Formularios</a>
                                        <ul class="dropdown-menu">
                                            <li class="nav-item">
                                                <a class="nav-link" href="/Principal/RegistrarPersona">Reg Formulario</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="/Principal/ListarFormularios">Ver Formularios</a>
                                            </li>
                                        </ul>
                                      </li> 


                                      <li class="nav-link">
                                        <a id="navi" href="#" class="dropdown-toggle" data-toggle="dropdown">Usuarios</a>
                                        <ul class="dropdown-menu">
                                            <li class="nav-item">
                                                <a class="nav-link" href="/Principal/VerUsuarios">Ver Usuarios</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="/Principal/CrearUsuario">Crear Usuario</a>
                                            </li>
                                        </ul>
                                      </li>
                                </li>
                              
                                <li class="nav-item">
                                    <a class="nav-link btn btn-primary text-white" type="button" href="/Principal/Login" >Iniciar Sesión</a>                  
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link btn btn-danger text-white" type="button" href="/Principal/CrearUsuario" >Registrar</a>
                                </li>
                            </ul>
                        </div>
                            
                
                    </nav>
                </div>
                
                                <!-- Navigation Bar  -->
                <br>



  <div class=" row"><!-- panel-footer -->
    <div class="col-xs-6 text-left">
        <div class="previous">
            <button class="btn btn-dark btn-lg" onclick="imprimirTabla()">Listar Formularios <span class="
                glyphicon glyphicon-list"></span></button>
            

          </button>
        </div>
    </div>
    <div class="col-xs-6 text-right">   
        <div class="next">
            <button class="btn btn-secondary btn-lg" id="btnServer" onclick="EnviarAlServer()">Enviar al Servidor  <span class="glyphicon glyphicon-floppy-open"></span></button>

          </button>
        </div>
    </div>
</div><!-- end panel-footer -->
    <br>
    <br>

            <div id="listarFormularios"></div>

            <!-- <iframe src="https://maps.google.com/maps?q=0, 0&z=15&output=embed" frameborder="0"
            style="border:0; width: 100%; height: 290px;" allowfullscreen id="map"></iframe> -->

                      <!-- Modal -->
    <div class="modal" id="myModal">
      <div class="modal-dialog">
          <div class="modal-content">

              <!-- Modal Header -->
              <div class="modal-header">
                  <h4 class="modal-title">Ubicación del Registro Seleccionado</h4>
                  <button type="button" class="close" data-dismiss="modal">×</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">
                <iframe src="https://maps.google.com/maps?q=0, 0&z=15&output=embed" frameborder="0"
                style="border:0; width: 100%; height: 290px;" allowfullscreen id="map"></iframe>
              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
              </div>

          </div>
      </div>
  </div>
  


</body>


<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>


        const db = new Dexie("Practica2_BrayanMnz");
          db.version(1).stores({
                        formulario: '++&id_formulario, nombre, sector, nivel_escolar, latitud, longitud, usuario_formulario',
                        usuario: '++&id_Usuario, username, passwd_Usuario, role_Usuario',


    }); 
    db.open().catch (function (err) {
    console.error('Failed to open db: ' + (err.stack || err));
});


          const x = [];

          const estudiantes =  db.formulario.toArray()
                  .then(list => {
                        list.forEach(item => {
                          x.push(item);
                                            });
                                })
                                  .catch(error => {
                                    alert("Se encontró un error: "+error);
                                                  });


    document.onload(imprimirTabla());

  function imprimirTabla() {
            //creando la tabla...
            var tabla = document.createElement("table");
            tabla.setAttribute("class","table table-hover table-dark"); 
            var filaTabla = tabla.insertRow();
            
            filaTabla.insertCell().textContent = "Id";
            filaTabla.insertCell().textContent = "Nombre";
            filaTabla.insertCell().textContent = "Sector";
            filaTabla.insertCell().textContent = "Nivel Escolar";
            filaTabla.insertCell().textContent = "Ubicación";
            filaTabla.insertCell().textContent = "Registrado Por";
            filaTabla.insertCell().textContent = "Acción";

            for (var key in x) {
                //
                filaTabla = tabla.insertRow();
                filaTabla.insertCell().textContent = ""+x[key].id_formulario;
                const id = x[key].id_formulario;
                console.log(id);
                filaTabla.insertCell().textContent = ""+x[key].nombre;  
                filaTabla.insertCell().textContent = ""+x[key].sector;
                filaTabla.insertCell().textContent = ""+x[key].nivel_escolar;


                filaTabla.insertCell().innerHTML =  "<a class='nav-link btn btn-primary text-white'  onclick='verMapa(\""+x[key].id_formulario+"\")' type='button' href='#' data-toggle='modal' data-target='#myModal'>Ver en Mapa</a>"

                filaTabla.insertCell().textContent = ""+x[key].usuario_formulario;
                filaTabla.insertCell().innerHTML =  "<button class='btn btn-info btn-sm' onclick='editar_form(\""+x[key].id_formulario+"\");''> <span class='glyphicon glyphicon-edit'></span></button> <span></span> <span><button class='btn btn-danger btn-sm' onclick='eliminar_form(\""+x[key].id_formulario+"\");''> <span class='glyphicon glyphicon-remove'></span></button></span>";
            }

            

            document.getElementById("listarFormularios").innerHTML="";
            document.getElementById("listarFormularios").appendChild(tabla);
        }


    function eliminar_form(param) {

    
      var id_Form = parseInt(param);
          

      let obj = x.find(o => o.id_formulario === id_Form);
      let indx = x.indexOf(obj); 

      
    db.transaction('rw', db.formulario, function* () {
    var deleteCount = yield db.formulario
        .where("id_formulario").equals(parseInt(id_Form))
        .delete();

        alert("Eliminados Correctamente: " + deleteCount + " Formularios");
    }).catch (e => {
        alert("Ocurrió un error al eliminar el elemento: "+e);
    });


      x.splice(indx,1);

      imprimirTabla();
      
    }


    function editar_form(param) {

    

    // var id_Form = parseInt(prompt("Indique Id del elemento a editar: "));
    var id_Form = parseInt(param);
    let obj = x.find(o => o.id_formulario === id_Form);
    let indx = x.indexOf(obj); 

    var name = prompt("Editar Nombre:", x[indx].nombre);
    var sect = prompt("Editar Sector:", x[indx].sector);
    var NvlEscolar = prompt("Editar Nivel Escolar:", x[indx].nivel_escolar);

    x[indx].nombre = name;
    x[indx].sector = sect;
    x[indx].nivel_escolar = NvlEscolar;
    

    db.formulario.update(id_Form, 
    {     nombre:  name,
          sector: sect,
          nivel_escolar: NvlEscolar,
          }).then(function (updated) {
        if (updated)
        alert("Se ha modificado el registro correspondiente a: "+x[indx].nombre);
  else
   alert("Ocurrió un error tratando de modificar a:"+x[indx].nombre);
});


}


    function verMapa(param) {

     var id_Form = parseInt(param);
      let obj = x.find(o => o.id_formulario === id_Form);
      let indx = x.indexOf(obj); 

      var latitud = x[indx].latitud;
      var longitud = x[indx].longitud;

      document.getElementById("map").src = "https://maps.google.com/maps?q=" + latitud + ", " + longitud +
            "&z=15&output=embed";

    }







        // W E B  S O C K E T 


                var webSocket;
                var tiempoReconectar = 5000;

            function EnviarAlServer() {

                try {
                    conectar(); 
                } catch (error) {
                    console.log("Error conectando al Web Socket "+error);
                    
                }
          
                
                if(!webSocket || webSocket.readyState == 3) {
                    alert("No tiene conexion con el servidor!");
                    conectar();
                }else{

                    const estudiantes =  db.formulario.toArray()
                        .then(list => {
                             list.forEach(item => {
                                
                                webSocket.send(JSON.stringify(item));
                                  });
                                           })
                        .catch(error => {
                          alert("Se encontró un error: "+error);
                                        });
                  
                    alert("Se han enviado los datos al servidor! ");
                    // dataBase.result.deleteObjectStore("formularios");
            } 
        }   

        /**
         *
         * @param mensaje
         */
        function recibirInformacionServidor(mensaje){
            console.log("Recibiendo del servidor: "+mensaje.data)
            $("#mensajeServidor").append(mensaje.data);
        }

        function conectar() {
            webSocket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/mensajeServidor");

            //indicando los eventos:
            webSocket.onmessage = function(data){recibirInformacionServidor(data);};
            webSocket.onopen  = function(e){ console.log("Conectado - status "+this.readyState); };
            webSocket.onclose = function(e){
                console.log("Desconectado - status "+this.readyState);
            };
        }

        
        function verificarConexion(){
            if(!webSocket || webSocket.readyState == 3){
                conectar();
            }
        }
        setInterval(verificarConexion, tiempoReconectar); //para reconectar.


</script>


</html>
